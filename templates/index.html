{% extends "base.html" %}

{% block content %}
  <section class="controls glass">
    <div class="controls__inner">
      <label class="controls__label" for="city-select">&#36873;&#25321;&#27743;&#35199;&#30465;&#22478;&#24066; / &#21439;&#21306;</label>
      <input
        id="city-search"
        class="city-search"
        type="text"
        placeholder="&#36755;&#20837;&#22478;&#24066;&#25110;&#21439;&#21306;&#36895;&#26597;"
        aria-label="&#36755;&#20837;&#22478;&#24066;&#25110;&#21439;&#21306;&#36895;&#26597;"
        autocomplete="off"
      >
      <div class="control-row">
        <select id="city-select" aria-label="&#36873;&#25321;&#27743;&#35199;&#30465;&#22478;&#24066;&#25110;&#21439;&#21306;">
          {% for location in locations %}
            <option value="{{ location.id }}" {% if location.id == default_location.id %}selected{% endif %}>
              {{ location.province }} &#183; {{ location.city }}
            </option>
          {% endfor %}
        </select>
        <button id="refresh-btn" type="button">åˆ·æ–°å¤©æ°”</button>
      </div>
    </div>
  </section>

  <section id="status-message" class="status-message {% if not load_error %}hidden{% endif %}">
    {{ load_error if load_error else "æ­£åœ¨åŠ è½½å¤©æ°”æ•°æ®..." }}
  </section>

  <section class="hero" id="weather-hero">
    <article class="hero-card glass">
      <div class="hero-top">
        <div class="hero-icon" id="current-icon">â˜€ï¸</div>
        <div class="hero-meta">
          <p class="hero-location" id="current-location">{{ default_location.province }} Â· {{ default_location.city }}</p>
          <p class="hero-updated">æ›´æ–°æ—¶é—´ <span id="current-updated">--</span></p>
        </div>
      </div>
      <div class="hero-temp">
        <span id="current-temperature" class="hero-temperature-value">--</span>
        <span class="hero-temperature-unit">â„ƒ</span>
      </div>
      <p id="current-summary" class="hero-summary">--</p>
    </article>

    <div class="metrics-grid glass">
      <article class="metric-card">
        <h3>é£é€Ÿ</h3>
        <p class="metric-value"><span id="current-windspeed">--</span><span class="metric-unit"> km/h</span></p>
      </article>
      <article class="metric-card">
        <h3>é£å‘</h3>
        <p class="metric-value"><span id="current-winddirection-text">--</span></p>
        <p class="metric-sub">(<span id="current-winddirection">--</span>Â°)</p>
      </article>
      <article class="metric-card">
        <h3>ä»Šæ—¥é™æ°´æ¦‚ç‡</h3>
        <p class="metric-value"><span id="current-precip">--</span><span class="metric-unit">%</span></p>
      </article>
      <article class="metric-card">
        <h3>åŸå¸‚åæ ‡</h3>
        <p class="metric-value" id="current-coordinates">--</p>
      </article>
    </div>
  </section>

  <section class="forecast-section">
    <div class="forecast-header">
      <h2>æœªæ¥ 5 æ—¥é¢„æŠ¥</h2>
      <p class="forecast-subtitle">å«æœ€é«˜ / æœ€ä½æ°”æ¸©ä¸é™æ°´æ¦‚ç‡</p>
    </div>
    <div id="forecast-list" class="forecast-list glass">
      <p class="placeholder">æš‚æ— é¢„æŠ¥æ•°æ®ã€‚</p>
    </div>
  </section>
{% endblock %}

{% block scripts %}

<script>
  const locations = {{ locations_json|tojson }};
  const defaultCityId = "{{ default_location.id }}";
  const initialForecast = {{ initial_forecast|tojson }};
  const initialError = {{ load_error|tojson }};

  const citySelect = document.getElementById("city-select");
  const citySearchInput = document.getElementById("city-search");
  const refreshBtn = document.getElementById("refresh-btn");
  const statusMessage = document.getElementById("status-message");
  const currentLocationEl = document.getElementById("current-location");
  const currentSummaryEl = document.getElementById("current-summary");
  const currentTempEl = document.getElementById("current-temperature");
  const currentIconEl = document.getElementById("current-icon");
  const currentWindSpeedEl = document.getElementById("current-windspeed");
  const currentWindDirectionEl = document.getElementById("current-winddirection");
  const currentWindDirectionTextEl = document.getElementById("current-winddirection-text");
  const currentUpdatedEl = document.getElementById("current-updated");
  const currentPrecipEl = document.getElementById("current-precip");
  const currentCoordinatesEl = document.getElementById("current-coordinates");
  const forecastListEl = document.getElementById("forecast-list");

  const DOT = "Â·";
  const GETTING_WEATHER_TEXT = "æ­£åœ¨è·å–å¤©æ°”æ•°æ®...";
  const REFRESHING_WEATHER_TEXT = "æ­£åœ¨åˆ·æ–°å¤©æ°”æ•°æ®...";
  const NO_DATA_TEXT = "æš‚æ— å¤©æ°”æ•°æ®ã€‚";
  const NO_FORECAST_TEXT = "æš‚æ— é¢„æŠ¥æ•°æ®ã€‚";
  const NO_MATCH_TEXT = "æœªæ‰¾åˆ°åŒ¹é…çš„åŸå¸‚æˆ–å¿åŒºã€‚";
  const NO_DESCRIPTION_TEXT = "æš‚æ— æè¿°";
  const WEEKDAY_NAMES = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];

  let currentCityId = defaultCityId;
  let filteredLocations = locations.slice();

  const weatherIconMap = new Map([
    [[0], "â˜€ï¸"],
    [[1, 2], "ğŸŒ¤ï¸"],
    [[3], "â˜ï¸"],
    [[45, 48], "ğŸŒ«ï¸"],
    [[51, 53, 55], "ğŸŒ¦ï¸"],
    [[56, 57, 66, 67], "ğŸŒ§ï¸"],
    [[61, 63, 65, 80, 81, 82], "ğŸŒ§ï¸"],
    [[71, 73, 75, 77, 85, 86], "ğŸŒ¨ï¸"],
    [[95, 96, 99], "â›ˆï¸"],
  ]);

  function createOptionLabel(location) {
    return `${location.province} ${DOT} ${location.city}`;
  }

  function formatNumber(value, digits = 1) {
    if (typeof value !== "number" || Number.isNaN(value)) {
      return "--";
    }
    return value.toFixed(digits);
  }

  function formatDate(dateStr) {
    if (!dateStr) {
      return "--";
    }
    try {
      const date = new Date(dateStr);
      return `${WEEKDAY_NAMES[date.getDay()]} Â· ${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    } catch (error) {
      return dateStr;
    }
  }

  function formatCoordinates(location) {
    if (!location) {
      return "--";
    }
    const latSuffix = location.latitude >= 0 ? "N" : "S";
    const lonSuffix = location.longitude >= 0 ? "E" : "W";
    return `${Math.abs(location.latitude).toFixed(2)}Â°${latSuffix} Â· ${Math.abs(location.longitude).toFixed(2)}Â°${lonSuffix}`;
  }

  function windDirectionToText(degrees) {
    if (typeof degrees !== "number" || Number.isNaN(degrees)) {
      return "--";
    }
    const directions = ["åŒ—", "ä¸œåŒ—", "ä¸œ", "ä¸œå—", "å—", "è¥¿å—", "è¥¿", "è¥¿åŒ—"];
    const index = Math.round(((degrees % 360) / 45)) % 8;
    return directions[index];
  }

  function setStatus(message, isError = false) {
    if (!message) {
      statusMessage.classList.add("hidden");
      statusMessage.textContent = "";
      statusMessage.classList.remove("error");
      return;
    }
    statusMessage.textContent = message;
    statusMessage.classList.remove("hidden");
    statusMessage.classList.toggle("error", Boolean(isError));
  }

  function rebuildOptions(list, preferredId) {
    citySelect.innerHTML = "";
    const fragment = document.createDocumentFragment();
    list.forEach((location) => {
      const option = document.createElement("option");
      option.value = location.id;
      option.textContent = createOptionLabel(location);
      fragment.appendChild(option);
    });
    citySelect.appendChild(fragment);
    if (list.length === 0) {
      citySelect.disabled = true;
      refreshBtn.disabled = true;
      citySelect.value = "";
      return;
    }
    citySelect.disabled = false;
    refreshBtn.disabled = false;
    const targetId = list.some((location) => location.id === preferredId) ? preferredId : list[0].id;
    citySelect.value = targetId;
  }

  function applyFilter(keyword) {
    const normalized = keyword.trim().toLowerCase();
    const next = normalized
      ? locations.filter((location) => {
          const haystack = `${location.province}${location.city}${location.id}`.toLowerCase();
          return haystack.includes(normalized);
        })
      : locations;
    filteredLocations = next;
    rebuildOptions(filteredLocations, currentCityId);
    if (filteredLocations.length === 0) {
      setStatus(NO_MATCH_TEXT, true);
      return;
    }
    setStatus(null);
    if (!filteredLocations.some((location) => location.id === currentCityId)) {
      currentCityId = filteredLocations[0].id;
      loadWeather(currentCityId, { silent: true });
    }
  }

  function getWeatherIcon(code) {
    for (const [codes, icon] of weatherIconMap.entries()) {
      if (codes.includes(code)) {
        return icon;
      }
    }
    return "ğŸŒˆ";
  }

  function renderForecast(forecast, city) {
    if (!forecast) {
      setStatus(NO_DATA_TEXT, true);
      return;
    }

    if (city && city.id) {
      currentCityId = city.id;
    }

    if (!filteredLocations.some((location) => location.id === currentCityId)) {
      filteredLocations = locations.slice();
      citySearchInput.value = "";
      rebuildOptions(filteredLocations, currentCityId);
    } else {
      citySelect.value = currentCityId;
    }

    const { current, daily } = forecast;
    currentLocationEl.textContent = `${city.province} ${DOT} ${city.city}`;
    currentSummaryEl.textContent = current?.weather ?? NO_DESCRIPTION_TEXT;
    currentTempEl.textContent = formatNumber(current?.temperature, 1);
    currentIconEl.textContent = getWeatherIcon(current?.weathercode);
    currentWindSpeedEl.textContent = formatNumber(current?.windspeed, 1);
    currentWindDirectionEl.textContent = formatNumber(current?.winddirection, 0);
    currentWindDirectionTextEl.textContent = windDirectionToText(current?.winddirection);
    currentUpdatedEl.textContent = current?.time || "--";
    currentCoordinatesEl.textContent = formatCoordinates(city);

    if (Array.isArray(daily) && daily.length > 0) {
      const today = daily[0];
      currentPrecipEl.textContent = formatNumber(today?.precipitation_probability, 0);
    } else {
      currentPrecipEl.textContent = "--";
    }

    forecastListEl.innerHTML = "";
    if (!Array.isArray(daily) || daily.length === 0) {
      forecastListEl.innerHTML = `<p class="placeholder">${NO_FORECAST_TEXT}</p>`;
      return;
    }

    daily.forEach((day) => {
      const item = document.createElement("article");
      item.className = "forecast-item";
      item.innerHTML = `
        <div class="forecast-icon">${getWeatherIcon(day.weathercode)}</div>
        <h3>${formatDate(day.date)}</h3>
        <p class="forecast-summary">${day.weather ?? NO_DESCRIPTION_TEXT}</p>
        <div class="forecast-temp">
          <span class="temp-max">${formatNumber(day.temperature_max, 1)}â„ƒ</span>
          <span class="temp-min">${formatNumber(day.temperature_min, 1)}â„ƒ</span>
        </div>
        <p class="forecast-precip">é™æ°´æ¦‚ç‡ <strong>${formatNumber(day.precipitation_probability, 0)}%</strong></p>
      `;
      forecastListEl.appendChild(item);
    });
  }

  async function loadWeather(cityId, { silent = false, message = GETTING_WEATHER_TEXT } = {}) {
    if (!silent) {
      setStatus(message);
    }
    try {
      const response = await fetch(`/api/weather?city=${encodeURIComponent(cityId)}`);
      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload.error || "å¤©æ°”æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚");
      }

      renderForecast(payload.forecast, payload.city);
      setStatus(null);
    } catch (error) {
      setStatus(error.message, true);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    rebuildOptions(filteredLocations, currentCityId);

    if (initialForecast && !initialError) {
      const defaultLocation = locations.find((item) => item.id === defaultCityId);
      if (defaultLocation) {
        renderForecast(initialForecast, defaultLocation);
      }
      setStatus(null);
    } else if (initialError) {
      setStatus(initialError, true);
    } else {
      loadWeather(defaultCityId, { silent: true });
    }

    citySelect.addEventListener("change", (event) => {
      const cityId = event.target.value;
      currentCityId = cityId;
      loadWeather(cityId, { silent: true });
    });

    citySearchInput.addEventListener("input", (event) => {
      applyFilter(event.target.value);
    });

    refreshBtn.addEventListener("click", () => {
      if (!citySelect.value) {
        return;
      }
      currentCityId = citySelect.value;
      loadWeather(currentCityId, { message: REFRESHING_WEATHER_TEXT });
    });
  });
</script>

{% endblock %}
