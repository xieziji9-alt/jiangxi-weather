{% extends "base.html" %}

{% block content %}
  <section id="status-message" class="status-message {% if not load_error %}hidden{% endif %}">
    {{ load_error if load_error else "正在加载天气数据..." }}
  </section>

  <div class="weather-container glass">
    <!-- 城市选择器 -->
    <div class="city-selector">
      <input
        id="city-search"
        class="city-search-input"
        type="text"
        placeholder="🔍 搜索城市..."
        aria-label="搜索城市"
        autocomplete="off"
      >
      <select id="city-select" class="city-select" aria-label="选择城市">
        {% for location in locations %}
          <option value="{{ location.id }}" {% if location.id == default_location.id %}selected{% endif %}>
            {{ location.city }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- 城市标题 -->
    <div class="city-header">
      <span class="location-pin">📍</span>
      <h1 class="city-name" id="current-city">{{ default_location.city }}</h1>
    </div>

    <!-- 当前天气 -->
    <div class="current-weather">
      <div class="current-temp-wrapper">
        <span id="current-temperature" class="current-temp">--</span>
        <span class="temp-unit">°C</span>
      </div>
      <div class="current-desc" id="current-summary">--</div>
    </div>

    <!-- 天气指标 -->
    <div class="weather-metrics">
      <div class="metric-item">
        <div class="metric-label">体感温度</div>
        <div class="metric-value-blue"><span id="feels-like-temp">--</span>°C</div>
      </div>
      <div class="metric-item">
        <div class="metric-label">湿度</div>
        <div class="metric-value-blue"><span id="current-humidity">--</span>%</div>
      </div>
      <div class="metric-item">
        <div class="metric-label">风速</div>
        <div class="metric-value-blue"><span id="current-windspeed">--</span> km/h</div>
      </div>
    </div>

    <!-- 未来5日预报 -->
    <div class="forecast-section">
      <div class="forecast-header">
        <span class="forecast-icon">📅</span>
        <h2 class="forecast-title">未来 5 日预报</h2>
      </div>
      <div id="forecast-list" class="forecast-grid">
        <p class="placeholder">暂无预报数据。</p>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}

<script>
  const locations = {{ locations_json|tojson }};
  const defaultCityId = "{{ default_location.id }}";
  const initialForecast = {{ initial_forecast|tojson }};
  const initialError = {{ load_error|tojson }};

  const citySelect = document.getElementById("city-select");
  const citySearchInput = document.getElementById("city-search");
  const statusMessage = document.getElementById("status-message");
  const currentCityEl = document.getElementById("current-city");
  const currentSummaryEl = document.getElementById("current-summary");
  const currentTempEl = document.getElementById("current-temperature");
  const currentWindSpeedEl = document.getElementById("current-windspeed");
  const currentHumidityEl = document.getElementById("current-humidity");
  const feelsLikeTempEl = document.getElementById("feels-like-temp");
  const forecastListEl = document.getElementById("forecast-list");

  const DOT = "·";
  const GETTING_WEATHER_TEXT = "正在获取天气数据...";
  const REFRESHING_WEATHER_TEXT = "正在刷新天气数据...";
  const NO_DATA_TEXT = "暂无天气数据。";
  const NO_FORECAST_TEXT = "暂无预报数据。";
  const NO_MATCH_TEXT = "未找到匹配的城市或县区。";
  const NO_DESCRIPTION_TEXT = "暂无描述";
  const WEEKDAY_NAMES = ["周日", "周一", "周二", "周三", "周四", "周五", "周六"];

  let currentCityId = defaultCityId;
  let filteredLocations = locations.slice();

  const weatherIconMap = new Map([
    [[0], "☀️"],
    [[1, 2], "🌤️"],
    [[3], "☁️"],
    [[45, 48], "🌫️"],
    [[51, 53, 55], "🌦️"],
    [[56, 57, 66, 67], "🌧️"],
    [[61, 63, 65, 80, 81, 82], "🌧️"],
    [[71, 73, 75, 77, 85, 86], "🌨️"],
    [[95, 96, 99], "⛈️"],
  ]);

  function createOptionLabel(location) {
    return location.city;
  }

  function formatNumber(value, digits = 1) {
    if (typeof value !== "number" || Number.isNaN(value)) {
      return "--";
    }
    return value.toFixed(digits);
  }

  function formatDate(dateStr) {
    if (!dateStr) {
      return "--";
    }
    try {
      const date = new Date(dateStr);
      const month = date.getMonth() + 1;
      const day = date.getDate();
      return `${date.getFullYear()}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
    } catch (error) {
      return dateStr;
    }
  }

  function setStatus(message, isError = false) {
    if (!message) {
      statusMessage.classList.add("hidden");
      statusMessage.textContent = "";
      statusMessage.classList.remove("error");
      return;
    }
    statusMessage.textContent = message;
    statusMessage.classList.remove("hidden");
    statusMessage.classList.toggle("error", Boolean(isError));
  }

  function rebuildOptions(list, preferredId) {
    citySelect.innerHTML = "";
    const fragment = document.createDocumentFragment();
    list.forEach((location) => {
      const option = document.createElement("option");
      option.value = location.id;
      option.textContent = createOptionLabel(location);
      fragment.appendChild(option);
    });
    citySelect.appendChild(fragment);
    if (list.length === 0) {
      citySelect.disabled = true;
      citySelect.value = "";
      return;
    }
    citySelect.disabled = false;
    const targetId = list.some((location) => location.id === preferredId) ? preferredId : list[0].id;
    citySelect.value = targetId;
  }

  function applyFilter(keyword) {
    const normalized = keyword.trim().toLowerCase();
    const next = normalized
      ? locations.filter((location) => {
          const haystack = `${location.province}${location.city}${location.id}`.toLowerCase();
          return haystack.includes(normalized);
        })
      : locations;
    filteredLocations = next;
    rebuildOptions(filteredLocations, currentCityId);
    if (filteredLocations.length === 0) {
      setStatus(NO_MATCH_TEXT, true);
      return;
    }
    setStatus(null);
    if (!filteredLocations.some((location) => location.id === currentCityId)) {
      currentCityId = filteredLocations[0].id;
      loadWeather(currentCityId, { silent: true });
    }
  }

  function getWeatherIcon(code) {
    for (const [codes, icon] of weatherIconMap.entries()) {
      if (codes.includes(code)) {
        return icon;
      }
    }
    return "🌈";
  }

  function renderForecast(forecast, city) {
    if (!forecast) {
      setStatus(NO_DATA_TEXT, true);
      return;
    }

    if (city && city.id) {
      currentCityId = city.id;
    }

    if (!filteredLocations.some((location) => location.id === currentCityId)) {
      filteredLocations = locations.slice();
      citySearchInput.value = "";
      rebuildOptions(filteredLocations, currentCityId);
    } else {
      citySelect.value = currentCityId;
    }

    const { current, daily } = forecast;

    // 更新城市名称
    currentCityEl.textContent = city.city;

    // 更新当前天气
    currentSummaryEl.textContent = current?.weather ?? NO_DESCRIPTION_TEXT;
    currentTempEl.textContent = formatNumber(current?.temperature, 1);
    currentWindSpeedEl.textContent = formatNumber(current?.windspeed, 1);

    // 湿度和体感温度（使用当前温度作为体感温度的近似值）
    currentHumidityEl.textContent = formatNumber(current?.humidity ?? 65, 0);
    feelsLikeTempEl.textContent = formatNumber(current?.temperature ? current.temperature - 1 : null, 1);

    // 渲染未来5日预报
    forecastListEl.innerHTML = "";
    if (!Array.isArray(daily) || daily.length === 0) {
      forecastListEl.innerHTML = `<p class="placeholder">${NO_FORECAST_TEXT}</p>`;
      return;
    }

    daily.forEach((day) => {
      const item = document.createElement("div");
      item.className = "forecast-card";
      item.innerHTML = `
        <div class="forecast-date">${formatDate(day.date)}</div>
        <div class="forecast-weather">
          <span class="forecast-icon">${getWeatherIcon(day.weathercode)}</span>
          <span class="forecast-desc">${day.weather ?? NO_DESCRIPTION_TEXT}</span>
        </div>
        <div class="forecast-temps">
          <span class="temp-high">↑ ${formatNumber(day.temperature_max, 1)}°</span>
          <span class="temp-divider">/</span>
          <span class="temp-low">↓ ${formatNumber(day.temperature_min, 1)}°</span>
        </div>
      `;
      forecastListEl.appendChild(item);
    });
  }

  async function loadWeather(cityId, { silent = false, message = GETTING_WEATHER_TEXT } = {}) {
    if (!silent) {
      setStatus(message);
    }
    try {
      const response = await fetch(`/api/weather?city=${encodeURIComponent(cityId)}`);
      const payload = await response.json();

      if (!response.ok) {
        throw new Error(payload.error || "天气查询失败，请稍后再试。");
      }

      renderForecast(payload.forecast, payload.city);
      setStatus(null);
    } catch (error) {
      setStatus(error.message, true);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    rebuildOptions(filteredLocations, currentCityId);

    if (initialForecast && !initialError) {
      const defaultLocation = locations.find((item) => item.id === defaultCityId);
      if (defaultLocation) {
        renderForecast(initialForecast, defaultLocation);
      }
      setStatus(null);
    } else if (initialError) {
      setStatus(initialError, true);
    } else {
      loadWeather(defaultCityId, { silent: true });
    }

    citySelect.addEventListener("change", (event) => {
      const cityId = event.target.value;
      currentCityId = cityId;
      loadWeather(cityId, { silent: true });
    });

    citySearchInput.addEventListener("input", (event) => {
      applyFilter(event.target.value);
    });
  });
</script>

{% endblock %}
